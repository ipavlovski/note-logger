generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = "file:./dev.db"
}

model Node {
    id Int @id @default(autoincrement())

    pid      Int?
    parent   Node?  @relation("NodeChain", fields: [pid], references: [id], onDelete: Cascade)
    children Node[] @relation("NodeChain")

    uri   String @unique
    title String

    iconId Int?
    icon   Icon? @relation(fields: [iconId], references: [id])

    previewId Int?
    preview   Preview? @relation(fields: [previewId], references: [id])

    lastVisitedAt DateTime?
    lastEditedAt  DateTime?

    tags     Tag[]
    metadata Metadata[]
    leafs    Leaf[]
    history  History[]
}

model Tag {
    id    Int     @id @default(autoincrement())
    name  String  @unique
    color String?
    node  Node[]
}

// key, value, type - type is Number/String/Boolean of the 'value'
model Metadata {
    id      Int    @id @default(autoincrement())
    node_id Int
    key     String
    value   String
    type    String
    node    Node   @relation(fields: [node_id], references: [id])

    @@unique([node_id, key, value], name: "metadata_key")
}

model Icon {
    id   Int    @id @default(autoincrement())
    node Node[]

    path   String  @unique
    source String? @unique
}

model Preview {
    id   Int    @id @default(autoincrement())
    node Node[]

    path   String  @unique
    source String? @unique
}

model History {
    id          Int      @id @default(autoincrement())
    node_id     Int
    node        Node     @relation(fields: [node_id], references: [id])
    visited_at  DateTime @unique
    imported_at DateTime @default(now())
}

model Leaf {
    id        Int      @id @default(autoincrement())
    node_id   Int
    node      Node     @relation(fields: [node_id], references: [id])
    images    Image[]
    content   String
    createdAt DateTime @default(now())
    order     Int      @default(0)
}

model Image {
    id      Int   @id @default(autoincrement())
    leaf_id Int
    leaf    Leaf? @relation(fields: [leaf_id], references: [id])

    path      String
    source    String?
    createdAt DateTime @default(now())
    order     Int      @default(0)
    type      String // enum: inline vs. gallery
    width     Int
    height    Int

    @@unique([leaf_id, path], name: "image_path")
}
